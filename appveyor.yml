version: "{build}"

platform:
  - Win32
  - x64

configuration: Debug

matrix:
  fast_finish: true

clone_folder: c:\projects\ja2-stracciatella
clone_depth: 1

init:
  - cmd: cmake --version
  - cmd: msbuild /version
  - cmd: echo %NIGHTLY_VERSION%

before_build:
  - cmd: mkdir ci-build
  - cmd: cd ci-build
  - cmd: if "%platform%"=="Win32" set CMAKE_GENERATOR_NAME=Visual Studio 14 2015
  - cmd: if "%platform%"=="x64"   set CMAKE_GENERATOR_NAME=Visual Studio 14 2015 Win64
  - cmd: cmake -G "%CMAKE_GENERATOR_NAME%" cmake -DCMAKE_BUILD_TYPE="%configuration%" -DBUILD_DATE="%NIGHTLY_VERSION%" -DCMAKE_TOOLCHAIN_FILE=./cmake/toolchain-msvc.cmake -DCPACK_GENERATOR=ZIP ..

build:
  project: ci-build\ja2-stracciatella.sln

after_build:
  - cmd: if "%NIGHTLY_VERSION%" NEQ "" cmake --build . --target package
  - ps: if (Test-Path env:NIGHTLY_VERSION) { Get-ChildItem ./ja2-stracciatella_*.zip | % { Push-AppveyorArtifact $_.FullName -FileName $_.Name } }

test_script:
  - cmd: cd %configuration%
  - cmd: ja2.exe -unittests

on_failure:
  - tree .

deploy:
  - provider: FTP
    protocol: sftp
    host: www61.your-server.de
    username:
      secure: uBUgFeI9sHRv0IiMPpA9rg==
    password:
      secure: gXqhlT/yjiLd/jTpvg4kcZtBRCZ8RnoOJ3zRTSF5voA=
    folder: nightlies

